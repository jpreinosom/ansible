---
# playbooks/instalar_scap_security_guide.yml

- name: Instalar paquetes necesarios en Ubuntu/Debian
  hosts: ubuntu_hosts
  become: yes
  tasks:
    - name: Habilitar repositorios universe
      apt_repository:
        repo: "deb http://archive.ubuntu.com/ubuntu/ {{ ansible_distribution_release }} universe"
        state: present

    - name: Actualizar la lista de paquetes
      apt:
        update_cache: yes

    - name: Instalar ssg-base y openscap-scanner
      apt:
        name:
          - ssg-base
          - openscap-scanner
        state: present

    - name: Verificar la instalación de oscap
      command: which oscap
      register: scap_installed
      ignore_errors: yes

    - name: Asegurarse de que oscap está instalado
      fail:
        msg: "oscap no se pudo instalar en {{ inventory_hostname }}"
      when: scap_installed.rc != 0

    - name: Descargar y compilar SCAP Security Guide (si es necesario)
      git:
        repo: https://github.com/ComplianceAsCode/content.git
        dest: /tmp/content
        version: main
      when: ansible_distribution == "Ubuntu"

    - name: Compilar el contenido SCAP (Ubuntu)
      command: ./build.sh
      args:
        chdir: /tmp/content
      when: ansible_distribution == "Ubuntu"

    - name: Copiar archivos XML de SCAP Security Guide para Ubuntu
      copy:
        src: "/tmp/content/build/content/ssg-ubuntu-{{ ansible_distribution_version.split('.')[0] }}.04-ds.xml"  # Ajusta según la versión
        dest: /usr/share/xml/scap/ssg/content/
        owner: root
        group: root
        mode: '0644'
      when:
        - ansible_distribution == "Ubuntu"
        - ansible_distribution_version is version('20.04', '>=')

- name: Instalar paquetes necesarios en CentOS/RHEL
  hosts: rhel_hosts
  become: yes
  tasks:
    - name: Instalar openscap-scanner y scap-security-guide
      dnf:
        name:
          - openscap-scanner
          - scap-security-guide
        state: present

    - name: Verificar la instalación de oscap
      command: which oscap
      register: scap_installed
      ignore_errors: yes

    - name: Asegurarse de que oscap está instalado
      fail:
        msg: "oscap no se pudo instalar en {{ inventory_hostname }}"
      when: scap_installed.rc != 0
